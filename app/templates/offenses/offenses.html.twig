{% extends "layout/dashboard.html.twig" %}

{% block content %}
<div class="min-h-screen bg-slate-900 flex flex-col">
    <div class="bg-gray-900 p-3 sm:p-6 border-b border-gray-800">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 sm:mb-6">
            <h1 class="text-xl sm:text-2xl font-bold text-white mb-3 sm:mb-0">D√©lits</h1>
            {% if is_granted('ROLE_ADMIN') %}
            <button type="button" class="w-full sm:w-auto px-4 py-2 bg-blue-700 text-blue-200 rounded hover:bg-blue-800 transition-colors text-sm" onclick="document.getElementById('add-offense-modal').classList.remove('hidden')">
                Ajouter un d√©lit
            </button>
            {% endif %}
        </div>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
            {% include 'offenses/components/filter_select.html.twig' with {label: 'Type', name: 'type', options: ['Tous'] + delitTypes} %}
            {% include 'offenses/components/filter_select.html.twig' with {label: 'Statut', name: 'status', options: ['Tous'] + delitStatuts} %}
            {% include 'offenses/components/filter_select.html.twig' with {label: 'Gravit√©', name: 'severity', options: ['Tous'] + delitGravites} %}
        </div>
    </div>
    
    <div class="flex flex-1 flex-col lg:flex-row overflow-hidden">
        <div class="w-full lg:w-1/4 lg:max-w-sm lg:min-w-[250px] bg-gray-900 p-3 sm:p-6 border-b lg:border-b-0 lg:border-r border-gray-800 overflow-y-auto max-h-80 lg:max-h-screen">
            <div class="space-y-2 sm:space-y-3">
                {% for offense in offenses %}
                    <div class="offense-card bg-gray-800 rounded-lg p-3 sm:p-4 cursor-pointer transition-colors hover:bg-gray-700 border-l-4
                        {% if selected and selected.id == offense.id %}border-blue-500 bg-gray-700{% else %}border-transparent{% endif %}"
                         data-offense-id="{{ offense.id }}">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-white font-semibold text-sm sm:text-base">#{{ offense.id }} - {{ offense.type }}</h3>
                            <span class="px-2 py-1 rounded text-xs flex-shrink-0
                                {% if offense.statut == 'en_cours' %}bg-yellow-600 text-yellow-200
                                {% elseif offense.statut == 'resolu' %}bg-green-600 text-green-200
                                {% elseif offense.statut == 'clos' %}bg-gray-600 text-gray-200
                                {% else %}bg-red-600 text-red-200{% endif %}">
                                {{ offense.statut|title }}
                            </span>
                        </div>
                        <p class="text-gray-300 text-xs sm:text-sm mb-2 line-clamp-2">{{ offense.description }}</p>
                        <div class="flex justify-between items-center text-xs text-gray-400">
                            <span>{{ offense.date|default('Date inconnue') }}</span>
                            <span class="px-2 py-1 rounded text-xs
                                {% if offense.gravite == 'faible' %}bg-green-600 text-green-200
                                {% elseif offense.gravite == 'moyenne' %}bg-yellow-600 text-yellow-200
                                {% elseif offense.gravite == 'elevee' %}bg-orange-600 text-orange-200
                                {% else %}bg-red-600 text-red-200{% endif %}">
                                {{ offense.gravite|title }}
                            </span>
                        </div>
                        {% if offense.politiciens|length > 0 or offense.partenaires|length > 0 %}
                            <div class="mt-2 flex gap-2 text-xs text-gray-400">
                                {% if offense.politiciens|length > 0 %}
                                    <span>üë• {{ offense.politiciens|length }}</span>
                                {% endif %}
                                {% if offense.partenaires|length > 0 %}
                                    <span>ü§ù {{ offense.partenaires|length }}</span>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="hidden lg:block lg:w-1/2 p-4 sm:p-6 overflow-y-auto border-r border-gray-800">
            <div id="offense-details">
                {% if selected %}
                    {% include 'offenses/components/offense_detail.html.twig' with {selected: selected} %}
                {% else %}
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <div class="text-gray-400 text-lg mb-2">S√©lectionnez un d√©lit pour voir les d√©tails</div>
                            <div class="text-gray-500 text-sm">Cliquez sur un d√©lit dans la liste √† gauche</div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="hidden lg:block lg:w-1/3 lg:min-w-[320px] bg-gray-900 p-4 sm:p-6 overflow-hidden border-l border-gray-800 flex flex-col h-full">
            <div id="comments-section" class="flex flex-col h-full">
                {% if selected %}
                    <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-800">
                        <div class="flex items-center space-x-2">
                            <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                                <span class="text-blue-200 text-sm font-semibold">üí¨</span>
                            </div>
                            <h2 class="text-white text-lg font-semibold">Commentaires</h2>
                        </div>
                        <span class="px-2 py-1 bg-gray-700 text-gray-300 text-xs rounded-full font-medium">
                            {{ selected.nombreCommentaires|default(0) }}
                        </span>
                    </div>
                    <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 mb-6">
                        <div class="flex items-center space-x-2 mb-4">
                            <h3 class="text-white text-sm font-semibold">Ajouter un commentaire</h3>
                        </div>
                        <form id="add-comment-form" class="space-y-4">
                            <div>
                                <textarea
                                    id="comment-content"
                                    name="contenu"
                                    rows="3"
                                    required
                                    class="w-full bg-gray-700 text-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                    placeholder="Partagez votre point de vue sur ce d√©lit..."
                                ></textarea>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-500 text-xs">Commentaire public</span>
                                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium flex items-center space-x-2">
                                    <span>Publier</span>
                                    <span class="text-xs">‚Üí</span>
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="flex-1 overflow-y-auto">
                        {% if selected.commentaires and selected.commentaires|length > 0 %}
                            <div class="space-y-4 mb-6 pr-2 scrollbar-thin scrollbar-thumb-gray-600 scrollbar-track-gray-800">
                                {% for commentaire in selected.commentaires %}
                                    <div class="bg-gray-800 rounded-lg p-4 border-l-4 border-blue-500 hover:bg-gray-750 transition-colors">
                                        <div class="flex items-start space-x-3">
                                            <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                                                <span class="text-blue-200 text-xs font-semibold">
                                                    {{ commentaire.auteur|split(' ')|first|first|upper }}{{ commentaire.auteur|split(' ')|last|first|upper }}
                                                </span>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center space-x-2 mb-2">
                                                    <span class="text-white font-medium text-sm">{{ commentaire.auteur }}</span>
                                                    <span class="text-gray-500 text-xs">‚Ä¢</span>
                                                    <span class="text-gray-400 text-xs">{{ commentaire.dateCreation }}</span>
                                                </div>
                                                <div class="text-gray-300 text-sm leading-relaxed">{{ commentaire.contenu }}</div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="mb-6 text-center py-8">
                                <div class="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <span class="text-gray-400 text-2xl">üí¨</span>
                                </div>
                                <p class="text-gray-400 text-sm mb-2">Aucun commentaire pour le moment</p>
                                <p class="text-gray-500 text-xs">Soyez le premier √† partager votre avis !</p>
                            </div>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <div class="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-gray-500 text-3xl">üí¨</span>
                            </div>
                            <div class="text-gray-400 text-lg mb-2 font-medium">S√©lectionnez un d√©lit</div>
                            <div class="text-gray-500 text-sm">pour voir et ajouter des commentaires</div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="lg:hidden">
        <div id="mobile-offense-details" class="bg-gray-900 border-t border-gray-800">
            {% if selected %}
                <div class="p-4">
                    {% include 'offenses/components/offense_detail.html.twig' with {selected: selected} %}
                </div>
            {% else %}
                <div class="p-4 text-center">
                    <div class="text-gray-400 text-sm mb-1">S√©lectionnez un d√©lit</div>
                    <div class="text-gray-500 text-xs">pour voir les d√©tails et commentaires</div>
                </div>
            {% endif %}
        </div>
        
        <div id="mobile-comments-section" class="bg-gray-900 border-t border-gray-800">
            {% if selected %}
                <div class="p-4">
                    <div class="flex items-center justify-between mb-4 pb-3 border-b border-gray-800">
                        <div class="flex items-center space-x-2">
                            <div class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center">
                                <span class="text-blue-200 text-xs font-semibold">üí¨</span>
                            </div>
                            <h2 class="text-white text-base font-semibold">Commentaires</h2>
                        </div>
                        <span class="px-2 py-1 bg-gray-700 text-gray-300 text-xs rounded-full font-medium">
                            {{ selected.nombreCommentaires|default(0) }}
                        </span>
                    </div>
                    
                    <div class="bg-gray-800 rounded-lg p-3 border border-gray-700 mb-4">
                        <form id="add-comment-form-mobile" class="space-y-3">
                            <div>
                                <textarea
                                    id="comment-content-mobile"
                                    name="contenu"
                                    rows="2"
                                    required
                                    class="w-full bg-gray-700 text-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-sm"
                                    placeholder="Votre commentaire..."
                                ></textarea>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-500 text-xs">Public</span>
                                <button type="submit" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm font-medium">
                                    Publier
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="max-h-80 overflow-y-auto">
                        {% if selected.commentaires and selected.commentaires|length > 0 %}
                            <div class="space-y-3">
                                {% for commentaire in selected.commentaires %}
                                    <div class="bg-gray-800 rounded-lg p-3 border-l-4 border-blue-500">
                                        <div class="flex items-start space-x-2">
                                            <div class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                                                <span class="text-blue-200 text-xs font-semibold">
                                                    {{ commentaire.auteur|split(' ')|first|first|upper }}{{ commentaire.auteur|split(' ')|last|first|upper }}
                                                </span>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center space-x-2 mb-1">
                                                    <span class="text-white font-medium text-sm">{{ commentaire.auteur }}</span>
                                                    <span class="text-gray-500 text-xs">‚Ä¢</span>
                                                    <span class="text-gray-400 text-xs">{{ commentaire.dateCreation }}</span>
                                                </div>
                                                <div class="text-gray-300 text-sm leading-relaxed">{{ commentaire.contenu }}</div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-6">
                                <div class="w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <span class="text-gray-400 text-lg">üí¨</span>
                                </div>
                                <p class="text-gray-400 text-sm mb-1">Aucun commentaire</p>
                                <p class="text-gray-500 text-xs">Soyez le premier √† commenter !</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<div id="add-offense-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden p-4">
    <div class="bg-[#101c2b] rounded-lg shadow-lg p-4 sm:p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-white text-lg font-semibold">Ajouter un d√©lit</h2>
            <button type="button" class="text-gray-400 hover:text-white text-2xl font-bold leading-none focus:outline-none" data-close-modal="add-offense-modal">&times;</button>
        </div>
        <div class="text-gray-300">
            <form id="add-offense-form" class="space-y-4 sm:space-y-6">
                <div>
                    <label class="block text-gray-300 text-sm mb-2" for="type">Type de d√©lit *</label>
                    <select id="type" name="type" required class="w-full bg-gray-800 text-gray-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">S√©lectionner un type</option>
                        {% for type in delitTypes %}
                            <option value="{{ type }}">{{ type|title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-gray-300 text-sm mb-2" for="description">Description *</label>
                    <textarea id="description" name="description" required rows="3" class="w-full bg-gray-800 text-gray-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Description du d√©lit..."></textarea>
                </div>

                <div>
                    <label class="block text-gray-300 text-sm mb-2" for="date">Date du d√©lit *</label>
                    <input type="date" id="date" name="date" required class="w-full bg-gray-800 text-gray-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-gray-300 text-sm mb-2" for="dateDeclaration">Date de d√©claration</label>
                    <input type="date" id="dateDeclaration" name="dateDeclaration" class="w-full bg-gray-800 text-gray-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-gray-300 text-sm mb-2" for="statut">Statut</label>
                    <select id="statut" name="statut" class="w-full bg-gray-800 text-gray-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        {% for statut in delitStatuts %}
                            <option value="{{ statut }}">{{ statut|title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-gray-300 text-sm mb-2" for="gravite">Gravit√©</label>
                    <select id="gravite" name="gravite" class="w-full bg-gray-800 text-gray-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        {% for gravite in delitGravites %}
                            <option value="{{ gravite }}">{{ gravite|title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-gray-300 text-sm mb-2" for="numeroAffaire">Num√©ro d'affaire</label>
                    <input type="text" id="numeroAffaire" name="numeroAffaire" class="w-full bg-gray-800 text-gray-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Num√©ro d'affaire...">
                </div>

                <div>
                    <label class="block text-gray-300 text-sm mb-2" for="procureurResponsable">Procureur responsable</label>
                    <input type="text" id="procureurResponsable" name="procureurResponsable" class="w-full bg-gray-800 text-gray-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nom du procureur...">
                </div>

                <div>
                    <label class="block text-gray-300 text-sm mb-2" for="politiciens">Politiciens impliqu√©s</label>
                    <select id="politiciens" name="politiciens[]" multiple class="w-full bg-gray-800 text-gray-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" size="4">
                        {% for politician in politicians %}
                            <option value="{{ politician.id }}">{{ politician.name }}</option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-gray-400 mt-1">Maintenez Ctrl (ou Cmd) pour s√©lectionner plusieurs politiciens</p>
                </div>

                <div>
                    <label class="block text-gray-300 text-sm mb-2" for="partenaires">Partenaires impliqu√©s</label>
                    <select id="partenaires" name="partenaires[]" multiple class="w-full bg-gray-800 text-gray-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" size="4">
                        {% for partner in partners %}
                            <option value="{{ partner.id }}">{{ partner.name }} ({{ partner.type }})</option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-gray-400 mt-1">Maintenez Ctrl (ou Cmd) pour s√©lectionner plusieurs partenaires</p>
                </div>

                <div class="flex flex-col sm:flex-row justify-end gap-3 pt-4">
                    <button type="button" class="px-4 py-2 bg-gray-600 text-gray-200 rounded hover:bg-gray-700 transition-colors" data-close-modal="add-offense-modal">
                        Annuler
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-700 text-blue-200 rounded hover:bg-blue-800 transition-colors">
                        Ajouter le d√©lit
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="edit-offense-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden p-4">
    <div class="bg-[#101c2b] rounded-lg shadow-lg p-4 sm:p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-white text-lg font-semibold">Modifier le d√©lit</h2>
            <button type="button" class="text-gray-400 hover:text-white text-2xl font-bold leading-none focus:outline-none" data-close-modal="edit-offense-modal">&times;</button>
        </div>
        <div class="text-gray-300">
            <form id="edit-offense-form" class="space-y-4 sm:space-y-6">
                <input type="hidden" id="edit-offense-id" name="id">
                
                <div>
                    <label class="block text-gray-300 text-sm mb-2" for="edit-type">Type de d√©lit *</label>
                    <select id="edit-type" name="type" required class="w-full bg-gray-800 text-gray-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">S√©lectionner un type</option>
                        {% for type in delitTypes %}
                            <option value="{{ type }}">{{ type|title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-gray-300 text-sm mb-2" for="edit-description">Description *</label>
                    <textarea id="edit-description" name="description" required rows="3" class="w-full bg-gray-800 text-gray-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Description du d√©lit..."></textarea>
                </div>

                <div>
                    <label class="block text-gray-300 text-sm mb-2" for="edit-date">Date du d√©lit *</label>
                    <input type="date" id="edit-date" name="date" required class="w-full bg-gray-800 text-gray-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-gray-300 text-sm mb-2" for="edit-dateDeclaration">Date de d√©claration</label>
                    <input type="date" id="edit-dateDeclaration" name="dateDeclaration" class="w-full bg-gray-800 text-gray-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-gray-300 text-sm mb-2" for="edit-statut">Statut</label>
                    <select id="edit-statut" name="statut" class="w-full bg-gray-800 text-gray-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        {% for statut in delitStatuts %}
                            <option value="{{ statut }}">{{ statut|title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-gray-300 text-sm mb-2" for="edit-gravite">Gravit√©</label>
                    <select id="edit-gravite" name="gravite" class="w-full bg-gray-800 text-gray-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        {% for gravite in delitGravites %}
                            <option value="{{ gravite }}">{{ gravite|title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-gray-300 text-sm mb-2" for="edit-numeroAffaire">Num√©ro d'affaire</label>
                    <input type="text" id="edit-numeroAffaire" name="numeroAffaire" class="w-full bg-gray-800 text-gray-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Num√©ro d'affaire...">
                </div>

                <div>
                    <label class="block text-gray-300 text-sm mb-2" for="edit-procureurResponsable">Procureur responsable</label>
                    <input type="text" id="edit-procureurResponsable" name="procureurResponsable" class="w-full bg-gray-800 text-gray-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nom du procureur...">
                </div>

                <div>
                    <label class="block text-gray-300 text-sm mb-2" for="edit-politiciens">Politiciens impliqu√©s</label>
                    <select id="edit-politiciens" name="politiciens[]" multiple class="w-full bg-gray-800 text-gray-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" size="4">
                        {% for politician in politicians %}
                            <option value="{{ politician.id }}">{{ politician.name }}</option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-gray-400 mt-1">Maintenez Ctrl (ou Cmd) pour s√©lectionner plusieurs politiciens</p>
                </div>

                <div>
                    <label class="block text-gray-300 text-sm mb-2" for="edit-partenaires">Partenaires impliqu√©s</label>
                    <select id="edit-partenaires" name="partenaires[]" multiple class="w-full bg-gray-800 text-gray-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" size="4">
                        {% for partner in partners %}
                            <option value="{{ partner.id }}">{{ partner.name }} ({{ partner.type }})</option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-gray-400 mt-1">Maintenez Ctrl (ou Cmd) pour s√©lectionner plusieurs partenaires</p>
                </div>

                <div class="flex flex-col sm:flex-row justify-end gap-3 pt-4">
                    <button type="button" class="px-4 py-2 bg-gray-600 text-gray-200 rounded hover:bg-gray-700 transition-colors" data-close-modal="edit-offense-modal">
                        Annuler
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-700 text-blue-200 rounded hover:bg-blue-800 transition-colors">
                        Modifier le d√©lit
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const offenses = {{ offenses|json_encode|raw }};
    let selectedOffense = {{ selected|json_encode|raw }};
    const isAdmin = {{ is_granted('ROLE_ADMIN') ? 'true' : 'false' }};
    const isModerator = {{ is_granted('ROLE_MODERATOR') ? 'true' : 'false' }};
    const isPolitician = {{ app.user and app.user.roles is defined and 'ROLE_POLITICIAN' in app.user.roles ? 'true' : 'false' }};
    const currentUserId = {{ app.user ? app.user.id : 'null' }};
    const politicians = {{ politicians|json_encode|raw }};
    const partners = {{ partners|json_encode|raw }};

    function showOffenseDetails(offenseId) {
        const offense = offenses.find(o => o.id === offenseId);
        if (offense) {
            selectedOffense = offense;
            
            const detailsHtml = generateOffenseDetailsHtml(offense);
            const desktopDetails = document.getElementById('offense-details');
            if (desktopDetails) {
                desktopDetails.innerHTML = detailsHtml;
            }
            
            const mobileDetails = document.getElementById('mobile-offense-details');
            if (mobileDetails && window.innerWidth < 1024) {
                mobileDetails.innerHTML = `<div class="p-4">${detailsHtml}</div>`;
            }
            
            updateCommentsSection(offense);
            
            document.querySelectorAll('.offense-card').forEach(card => {
                card.classList.remove('ring-2', 'ring-blue-500');
            });
            document.querySelector(`[data-offense-id="${offenseId}"]`).classList.add('ring-2', 'ring-blue-500');
        }
    }

    function updateCommentsSection(offense) {
        const commentsSection = document.getElementById('comments-section');
        
        if (!offense) {
            commentsSection.innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="text-center">
                        <div class="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-gray-500 text-3xl">üí¨</span>
                        </div>
                        <div class="text-gray-400 text-lg mb-2 font-medium">S√©lectionnez un d√©lit</div>
                        <div class="text-gray-500 text-sm">pour voir et ajouter des commentaires</div>
                    </div>
                </div>
            `;
            return;
        }
        
        if (!offense.commentaires && offense.nombreCommentaires > 0) {
            fetch(`/offenses/${offense.id}/comments`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        offense.commentaires = data.commentaires;
                        renderCommentsSection(offense);
                    }
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des commentaires:', error);
                    renderCommentsSection(offense);
                });
        } else {
            renderCommentsSection(offense);
        }
    }

    function renderCommentsSection(offense) {
        const commentsSection = document.getElementById('comments-section');
        let commentsHtml = `
            <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-800">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                        <span class="text-blue-200 text-sm font-semibold">üí¨</span>
                    </div>
                    <h2 class="text-white text-lg font-semibold">Commentaires</h2>
                </div>
                <span class="px-2 py-1 bg-gray-700 text-gray-300 text-xs rounded-full font-medium">
                    ${offense.nombreCommentaires || 0}
                </span>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 mb-6">
                <div class="flex items-center space-x-2 mb-4">
                    <h3 class="text-white text-sm font-semibold">Ajouter un commentaire</h3>
                </div>
                <form id="add-comment-form" class="space-y-4">
                    <div>
                        <textarea id="comment-content" name="contenu" rows="3" required class="w-full bg-gray-700 text-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" placeholder="Partagez votre point de vue sur ce d√©lit..." ></textarea>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-500 text-xs">Commentaire public</span>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium flex items-center space-x-2">
                            <span>Publier</span>
                            <span class="text-xs">‚Üí</span>
                        </button>
                    </div>
                </form>
            </div>
        `;

        commentsHtml += `<div class="flex-1 overflow-y-auto">`;
        if (offense.commentaires && offense.commentaires.length > 0) {
            commentsHtml += `<div class="space-y-4 mb-6 pr-2 scrollbar-thin scrollbar-thumb-gray-600 scrollbar-track-gray-800">`;
            offense.commentaires.forEach(commentaire => {
                const authorName = commentaire.auteur;
                const initials = authorName.split(' ').map(name => name.charAt(0).toUpperCase()).join('');
                
                commentsHtml += `
                    <div class="bg-gray-800 rounded-lg p-4 border-l-4 border-blue-500 hover:bg-gray-750 transition-colors">
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                                <span class="text-blue-200 text-xs font-semibold">${initials}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="text-white font-medium text-sm">${commentaire.auteur}</span>
                                    <span class="text-gray-500 text-xs">‚Ä¢</span>
                                    <span class="text-gray-400 text-xs">${commentaire.dateCreation}</span>
                                </div>
                                <div class="text-gray-300 text-sm leading-relaxed">${commentaire.contenu}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            commentsHtml += `</div>`;
        } else {
            commentsHtml += `
                <div class="mb-6 text-center py-8">
                    <div class="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-gray-400 text-2xl">üí¨</span>
                    </div>
                    <p class="text-gray-400 text-sm mb-2">Aucun commentaire pour le moment</p>
                    <p class="text-gray-500 text-xs">Soyez le premier √† partager votre avis !</p>
                </div>
            `;
        }
        commentsHtml += `</div>`;
        
        commentsSection.innerHTML = commentsHtml;
    }

    function generateOffenseDetailsHtml(offense) {
        return `
            <div class="bg-[#101c2b] rounded-lg shadow-lg p-6 h-full overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-white text-xl font-semibold">D√©tails du d√©lit</h2>
                    ${isAdmin || isModerator || (isPolitician && currentUserId && offense.politiciens && offense.politiciens.some(p => p.id === currentUserId)) ? `<button type="button" class="px-3 py-1 rounded text-xs font-semibold transition-colors focus:outline-none bg-blue-700 text-blue-200 hover:bg-blue-800" onclick="editOffense(${offense.id})">
                        Modifier
                    </button>` : ''}
                </div>

                <h2 class="text-white text-lg font-semibold mb-4">Informations de base</h2>
                <div class="grid grid-cols-2 gap-6 border-b border-slate-800 pb-6 mb-6">
                    <div>
                        <div class="text-gray-400 text-xs mb-1">Type</div>
                        <div class="text-white">${offense.type}</div>
                    </div>
                    <div>
                        <div class="text-gray-400 text-xs mb-1">Statut</div>
                        <div class="text-white">${offense.statut}</div>
                    </div>
                    <div>
                        <div class="text-gray-400 text-xs mb-1">Gravit√©</div>
                        <div class="text-white">${offense.gravite}</div>
                    </div>
                    <div>
                        <div class="text-gray-400 text-xs mb-1">Date</div>
                        <div class="text-white">${offense.date}</div>
                    </div>
                    ${offense.dateDeclaration ? `
                    <div>
                        <div class="text-gray-400 text-xs mb-1">Date de d√©claration</div>
                        <div class="text-white">${offense.dateDeclaration}</div>
                    </div>
                    ` : ''}
                    ${offense.numeroAffaire ? `
                    <div>
                        <div class="text-gray-400 text-xs mb-1">Num√©ro d'affaire</div>
                        <div class="text-white">${offense.numeroAffaire}</div>
                    </div>
                    ` : ''}
                    ${offense.procureurResponsable ? `
                    <div>
                        <div class="text-gray-400 text-xs mb-1">Procureur responsable</div>
                        <div class="text-white">${offense.procureurResponsable}</div>
                    </div>
                    ` : ''}
                </div>

                ${offense.description ? `
                <h2 class="text-white text-lg font-semibold mb-4">Description</h2>
                <div class="border-b border-slate-800 pb-6 mb-6">
                    <div class="text-white">${offense.description}</div>
                </div>
                ` : ''}

                ${offense.lieu ? `
                <h2 class="text-white text-lg font-semibold mb-4">Lieu</h2>
                <div class="grid grid-cols-2 gap-6 border-b border-slate-800 pb-6 mb-6">
                    <div>
                        <div class="text-gray-400 text-xs mb-1">Adresse</div>
                        <div class="text-white">${offense.lieu}</div>
                    </div>
                </div>
                ` : ''}

                ${offense.politiciens && offense.politiciens.length > 0 ? `
                <h2 class="text-white text-lg font-semibold mb-4">Politiciens impliqu√©s</h2>
                <div class="grid grid-cols-1 gap-4 border-b border-slate-800 pb-6 mb-6">
                    ${offense.politiciens.map(politicien => `
                        <div class="bg-gray-800 rounded p-3">
                            <div class="text-white font-medium">${politicien.name}</div>
                            <div class="text-gray-400 text-sm">${politicien.email}</div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}

                ${offense.partenaires && offense.partenaires.length > 0 ? `
                <h2 class="text-white text-lg font-semibold mb-4">Partenaires impliqu√©s</h2>
                <div class="grid grid-cols-1 gap-4 border-b border-slate-800 pb-6 mb-6">
                    ${offense.partenaires.map(partenaire => `
                        <div class="bg-gray-800 rounded p-3">
                            <div class="text-white font-medium">${partenaire.name}</div>
                            <div class="text-gray-400 text-sm">${partenaire.type}</div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}

                ${offense.documents && offense.documents.length > 0 ? `
                <h2 class="text-white text-lg font-semibold mb-4">Documents (${offense.nombreDocuments})</h2>
                <div class="grid grid-cols-1 gap-4">
                    ${offense.documents.map(document => `
                        <div class="bg-gray-800 rounded p-3">
                            <div class="text-white font-medium">${document.titre}</div>
                            <div class="text-gray-400 text-sm">
                                Type: ${document.type} | 
                                Cr√©√© le: ${document.dateCreation}
                                ${document.niveauConfidentialite ? ` | Confidentialit√©: ${document.niveauConfidentialite}` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
            </div>
        `;
    }

    function loadPoliticiansAndPartners() {
        console.log('Chargement des politiciens et partenaires...');
        console.log('Politiciens disponibles:', politicians);
        console.log('Partenaires disponibles:', partners);
        
        const politiciensSelect = document.getElementById('politiciens');
        const editPoliticiensSelect = document.getElementById('edit-politiciens');
        
        if (politiciensSelect && editPoliticiensSelect) {
            politiciensSelect.innerHTML = '<option value="">Aucun politicien</option>';
            editPoliticiensSelect.innerHTML = '<option value="">Aucun politicien</option>';
            
            politicians.forEach(politician => {
                const option = document.createElement('option');
                option.value = politician.id;
                option.textContent = politician.name;
                politiciensSelect.appendChild(option);
                
                const editOption = document.createElement('option');
                editOption.value = politician.id;
                editOption.textContent = politician.name;
                editPoliticiensSelect.appendChild(editOption);
            });
        }

        const partenairesSelect = document.getElementById('partenaires');
        const editPartenairesSelect = document.getElementById('edit-partenaires');
        
        if (partenairesSelect && editPartenairesSelect) {
            partenairesSelect.innerHTML = '<option value="">Aucun partenaire</option>';
            editPartenairesSelect.innerHTML = '<option value="">Aucun partenaire</option>';
            
            partners.forEach(partner => {
                const option = document.createElement('option');
                option.value = partner.id;
                option.textContent = partner.name;
                partenairesSelect.appendChild(option);
                
                const editOption = document.createElement('option');
                editOption.value = partner.id;
                editOption.textContent = partner.name;
                editPartenairesSelect.appendChild(editOption);
            });
        }
    }

    function editOffense(offenseId) {
        fetch(`/offenses/${offenseId}/edit`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const offense = data.offense;
                    
                    document.getElementById('edit-offense-id').value = offense.id;
                    document.getElementById('edit-type').value = offense.type;
                    document.getElementById('edit-description').value = offense.description;
                    document.getElementById('edit-date').value = offense.date;
                    document.getElementById('edit-dateDeclaration').value = offense.dateDeclaration || '';
                    document.getElementById('edit-statut').value = offense.statut;
                    document.getElementById('edit-gravite').value = offense.gravite;
                    document.getElementById('edit-numeroAffaire').value = offense.numeroAffaire || '';
                    document.getElementById('edit-procureurResponsable').value = offense.procureurResponsable || '';
                    
                    const politiciensSelect = document.getElementById('edit-politiciens');
                    Array.from(politiciensSelect.options).forEach(option => {
                        option.selected = offense.politiciens && offense.politiciens.includes(parseInt(option.value));
                    });
                    
                    const partenairesSelect = document.getElementById('edit-partenaires');
                    Array.from(partenairesSelect.options).forEach(option => {
                        option.selected = offense.partenaires && offense.partenaires.includes(parseInt(option.value));
                    });
                    
                    document.getElementById('edit-offense-modal').classList.remove('hidden');
                } else {
                    alert('Erreur lors du chargement du d√©lit: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors du chargement du d√©lit');
            });
    }

    function showSuccessMessage(message) {
        showToast(message, 'success');
    }

    function showErrorMessage(message) {
        showToast(message, 'error');
    }

    function showToast(message, type = 'info') {
        const existingToasts = document.querySelectorAll('.toast-message');
        existingToasts.forEach(toast => toast.remove());

        const toast = document.createElement('div');
        toast.className = `toast-message fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
        
        const bgColor = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
        const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
        
        toast.innerHTML = `
            <div class="flex items-center space-x-2">
                <span class="text-white text-sm">${icon}</span>
                <span class="text-white text-sm font-medium">${message}</span>
            </div>
        `;
        
        toast.classList.add(bgColor);
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.remove('translate-x-full');
        }, 100);
        
        setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (selectedOffense) {
            showOffenseDetails(selectedOffense.id);
        } else {
            updateCommentsSection(null);
        }

        document.querySelectorAll('.offense-card').forEach(card => {
            card.addEventListener('click', function() {
                const offenseId = parseInt(this.dataset.offenseId);
                showOffenseDetails(offenseId);
            });
        });

        document.querySelectorAll('.filter-select').forEach(select => {
            select.addEventListener('change', function() {
                const filterType = this.name;
                const filterValue = this.value;
                
                document.querySelectorAll('.offense-card').forEach(card => {
                    const offenseId = parseInt(card.dataset.offenseId);
                    const offense = offenses.find(o => o.id === offenseId);
                    
                    let show = true;
                    
                    if (filterType === 'type' && filterValue && filterValue !== 'Tous') {
                        show = offense.type === filterValue;
                    } else if (filterType === 'status' && filterValue && filterValue !== 'Tous') {
                        show = offense.statut === filterValue;
                    } else if (filterType === 'severity' && filterValue && filterValue !== 'Tous') {
                        show = offense.gravite === filterValue;
                    }
                    
                    card.style.display = show ? 'block' : 'none';
                });
            });
        });

        loadPoliticiansAndPartners();
        
        document.getElementById('add-offense-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            
            submitButton.textContent = 'Ajout en cours...';
            submitButton.disabled = true;
            
            const formData = new FormData(this);
            
            fetch('/offenses/add', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('R√©ponse ajout:', response);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Donn√©es ajout:', data);
                if (data.success) {
                    alert('D√©lit ajout√© avec succ√®s !');
                    
                    document.getElementById('add-offense-modal').classList.add('hidden');
                    
                    window.location.reload();
                } else {
                    alert('Erreur lors de l\'ajout du d√©lit: ' + (data.error || 'Erreur inconnue'));
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors de l\'ajout du d√©lit: ' + error.message);
            })
            .finally(() => {
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            });
        });

        document.getElementById('edit-offense-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            
            submitButton.textContent = 'Modification en cours...';
            submitButton.disabled = true;
            
            const formData = new FormData(this);
            const offenseId = formData.get('id');
            
            fetch(`/offenses/${offenseId}/update`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('R√©ponse modification:', response);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Donn√©es modification:', data);
                if (data.success) {
                    alert('D√©lit modifi√© avec succ√®s !');
                    
                    document.getElementById('edit-offense-modal').classList.add('hidden');
                    
                    window.location.reload();
                } else {
                    alert('Erreur lors de la modification du d√©lit: ' + (data.error || 'Erreur inconnue'));
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors de la modification du d√©lit: ' + error.message);
            })
            .finally(() => {
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            });
        });

        document.addEventListener('submit', function(e) {
            if (e.target.id === 'add-comment-form' || e.target.id === 'add-comment-form-mobile') {
                e.preventDefault();
                
                if (!selectedOffense) {
                    alert('Aucun d√©lit s√©lectionn√©');
                    return;
                }
                
                const form = e.target;
                const submitButton = form.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                const textarea = form.querySelector('textarea[name="contenu"]');
                const content = textarea.value.trim();
                
                if (!content) {
                    alert('Le contenu du commentaire est requis');
                    return;
                }
                
                submitButton.innerHTML = `
                    <span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                    <span>Publication...</span>
                `;
                submitButton.disabled = true;
                
                const formData = new FormData();
                formData.append('contenu', content);
                
                fetch(`/offenses/${selectedOffense.id}/comment`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        if (!selectedOffense.commentaires) {
                            selectedOffense.commentaires = [];
                        }
                        selectedOffense.commentaires.push(data.commentaire);
                        selectedOffense.nombreCommentaires = (selectedOffense.nombreCommentaires || 0) + 1;
                        
                        renderCommentsSection(selectedOffense);
                        
                        textarea.value = '';
                        
                        setTimeout(() => {
                            const newComment = document.querySelector('.bg-gray-800.rounded-lg:last-child');
                            if (newComment) {
                                newComment.style.transform = 'scale(1.02)';
                                newComment.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.3)';
                                setTimeout(() => {
                                    newComment.style.transform = 'scale(1)';
                                    newComment.style.boxShadow = 'none';
                                }, 500);
                            }
                        }, 100);
                        
                        showSuccessMessage('Commentaire ajout√© avec succ√®s !');
                        
                        if (window.innerWidth < 1024) {
                            window.location.reload();
                        }
                    } else {
                        showErrorMessage('Erreur lors de l\'ajout du commentaire: ' + (data.error || 'Erreur inconnue'));
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors de l\'ajout du commentaire: ' + error.message);
                })
                .finally(() => {
                    if (e.target.id === 'add-comment-form') {
                        submitButton.innerHTML = `
                            <span>Publier</span>
                            <span class="text-xs">‚Üí</span>
                        `;
                    } else {
                        submitButton.textContent = 'Publier';
                    }
                    submitButton.disabled = false;
                });
            }
        });
    });
</script>
{% endblock %}